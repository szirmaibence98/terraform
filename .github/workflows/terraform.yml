name: 'Terraform Azure'

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  terraform-plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    outputs:
      plan-file: ${{ steps.set-plan-file.outputs.plan-file }}
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_ACCESS_KEY: ${{ secrets.ARM_ACCESS_KEY }}
      TF_ENV: staging # This can be dynamically set or changed as needed

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: latest

    - name: Terraform Init with Dynamic Backend Config
      run: |
        terraform init \
          -backend-config="access_key=${{ secrets.ARM_ACCESS_KEY }}" \
          -backend-config="container_name=statefiles" \
          -backend-config="key=${{ env.TF_ENV }}-terraform.tfstate"

    - name: Set Plan File Name
      id: set-plan-file
      run: echo "::set-output name=plan-file::planfile-${{ env.TF_ENV }}.tfplan"

    - name: Terraform Plan
      run: terraform plan -out=${{ steps.set-plan-file.outputs.plan-file }}

  terraform-apply:
    name: 'Terraform Apply'
    needs: terraform-plan
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.terraform-plan.outputs.TF_ENV }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: latest

    - name: Terraform Init with Dynamic Backend Config (Again for Apply)
      run: |
        terraform init \
          -backend-config="access_key=${{ secrets.ARM_ACCESS_KEY }}" \
          -backend-config="container_name=statefiles" \
          -backend-config="key=${{ env.TF_ENV }}-terraform.tfstate"

    - name: Terraform Apply
      run: terraform apply "${{ needs.terraform-plan.outputs.plan-file }}"
